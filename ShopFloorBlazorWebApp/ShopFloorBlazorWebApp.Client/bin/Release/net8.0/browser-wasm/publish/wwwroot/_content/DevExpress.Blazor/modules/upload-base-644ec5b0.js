import{_ as e}from"./_tslib-6e8ca86b.js";import{d as t}from"./dom-da46d023.js";import{C as s}from"./custom-events-helper-e7f279d3.js";import{S as i}from"./single-slot-element-base-3afabaf0.js";import{C as o}from"./css-classes-cee8476c.js";import{n as a}from"./property-4ec0b52d.js";const r="dxbl-upload";class n{constructor(e){this.progress=e}}class l{constructor(e){this.requestOptions=e}}class d extends CustomEvent{constructor(e){super(d.eventName,{detail:new n(e),bubbles:!0,composed:!0})}}d.eventName=r+".uploadprogress",s.register(d.eventName,(e=>e.detail));class u extends CustomEvent{constructor(e){super(u.eventName,{detail:new l(e),bubbles:!0,composed:!0})}}u.eventName=r+".customizeformdata",s.register(u.eventName,(e=>e.detail));class c extends CustomEvent{constructor(){super(c.eventName,{bubbles:!0,composed:!0})}}c.eventName=r+".maxfilecountexceeded",s.register(c.eventName,(e=>null));const h=10;var p,m,f,g;!function(e){e.acceptedFileTypes="accepted-file-types",e.allowedFileExtensions="allowed-file-extensions",e.externalSelectButtonCssSelector="external-select-button-css-selector",e.chunkSize="chunk-size",e.maxFileSize="max-file-size",e.minFileSize="min-file-size",e.maxFileCount="max-file-count",e.multiple="multiple",e.uploadMode="upload-mode",e.uploadTechnology="upload-technology",e.dragOverClassName="drag-over-class-name",e.dropZoneCssSelector="drop-zone-css-selector",e.customizeFormData="customize-form-data"}(p||(p={})),function(e){e[e.Instant=0]="Instant",e[e.OnButtonClick=1]="OnButtonClick"}(m||(m={})),function(e){e[e.Http=0]="Http",e[e.JsInterop=1]="JsInterop"}(f||(f={})),function(e){e[e.WaitingStart=0]="WaitingStart",e[e.PendingUpload=1]="PendingUpload",e[e.Uploading=2]="Uploading",e[e.Paused=3]="Paused",e[e.Complete=4]="Complete",e[e.Canceled=5]="Canceled",e[e.Error=6]="Error",e[e.Removing=7]="Removing"}(g||(g={}));class F{constructor(){this.guids=[],this.actions=[],this.reloadedFileGuids=[]}}class v{constructor(e){this.FileName=e.fileInfo.name,this.FileSize=e.fileInfo.size,this.FileType=e.fileInfo.type,this.LastModified=e.fileInfo.lastModified,this.FileGuid=e.fileInfo.guid,this.Index=e.chunkIndex,this.TotalCount=e.totalChunkCount}}class S{constructor(e,t,s){this._value=e,this._status=s.uploadMode===m.Instant?g.PendingUpload:g.WaitingStart,this._chunkIndex=0,this._loadedBytes=0,this._totalChunkCount=0,this._isFileExtensionValid=S.validateFileExtension(e,s),this._isMinSizeValid=S.validateMinFileSize(e,s),this._isMaxSizeValid=S.validateMaxFileSize(e,s),this._fileInfo={name:e.name,size:e.size,type:e.type,lastModified:1e4*e.lastModified+621355968e9,guid:t},this._request=null,this._onLoadStart=null,this._onProgress=null,this._onAbort=null,this._onPause=null,this._onError=null,this._onLoadEnd=null,this.isValid()||(this._status=g.Error)}get value(){return this._value}get status(){return this._status}set status(e){this._status=e}get chunkIndex(){return this._chunkIndex}set chunkIndex(e){this._chunkIndex=e}get loadedBytes(){return this._loadedBytes}set loadedBytes(e){this._loadedBytes=e}get totalChunkCount(){return this._totalChunkCount}set totalChunkCount(e){this._totalChunkCount=e}get isFileExtensionValid(){return this._isFileExtensionValid}get isMinSizeValid(){return this._isMinSizeValid}get isMaxSizeValid(){return this._isMaxSizeValid}get fileInfo(){return this._fileInfo}get request(){return this._request}set request(e){this._request=e}get onLoadStart(){return this._onLoadStart}set onLoadStart(e){this._onLoadStart=e}get onProgress(){return this._onProgress}set onProgress(e){this._onProgress=e}get onAbort(){return this._onAbort}set onAbort(e){this._onAbort=e}get onError(){return this._onError}set onError(e){this._onError=e}get onLoadEnd(){return this._onLoadEnd}set onLoadEnd(e){this._onLoadEnd=e}isValid(){return this.isFileExtensionValid&&this.isMaxSizeValid&&this.isMinSizeValid}isUploadComplete(){return this.loadedBytes>=this.fileInfo.size}loadStart(){this.status!==g.Uploading&&(this.status=g.Uploading,this.onLoadStart&&this.onLoadStart.call(this))}progress(){this.onProgress&&this.onProgress.call(this)}loadEnd(){this.isUploadComplete()&&(this.status=g.Complete,this.onLoadEnd&&this.onLoadEnd.call(this))}abort(e=!0){this.status!==g.Canceled&&(this.status=g.Canceled,this.request&&this.request.abort(),e&&this.onAbort&&this.onAbort.call(this),this.chunkIndex=0,this.loadedBytes=0)}error(e){this.status=g.Error,this.onError&&this.onError.call(this,e)}static validateFileExtension(e,t){const s=t.allowedFileExtensions,i=e.name.substring(e.name.lastIndexOf(".")).toLowerCase();if(0===s.length)return!0;for(let e=0;e<s.length;e++)if(i===s[e].toLowerCase())return!0;return!1}static validateMinFileSize(e,t){const s=t.minFileSize;return!(s>0)||e.size>=s}static validateMaxFileSize(e,t){const s=t.maxFileSize;return!(s>0)||e.size<=s}updateStatus(e,t){var s,i,o,a,r,n,l;switch(this.status=e,this.status){case g.WaitingStart:case g.PendingUpload:break;case g.Uploading:null===(s=this.onLoadStart)||void 0===s||s.call(this);break;case g.Paused:break;case g.Complete:this.loadedBytes=this.value.size,null===(i=this.onLoadEnd)||void 0===i||i.call(this);break;case g.Canceled:null===(o=this.onAbort)||void 0===o||o.call(this);break;case g.Error:{const e=new EventTarget;e.status=null!==(a=null==t?void 0:t.status)&&void 0!==a?a:-1,e.statusText=null!==(r=null==t?void 0:t.statusText)&&void 0!==r?r:"Unexpected error",e.responseText=null!==(n=null==t?void 0:t.responseText)&&void 0!==n?n:"Unexpected error",null===(l=this.onError)||void 0===l||l.call(this,e);break}}}}class C{constructor(e){this.control=e,this.requestMetadata=null}customizeFormData(e){return this.control.dispatchEvent(new u(e)),Promise.resolve()}}class I extends C{constructor(e){super(e)}upload(e,t,s,i){if(!e)return Promise.reject();e.totalChunkCount||(e.chunkIndex=0,e.totalChunkCount=I.calculateTotalChunkCount(e.fileInfo.size,t));const o=t.chunkSize*e.chunkIndex,a=e.value.slice(o,o+t.chunkSize);return this.requestMetadata={formData:new FormData,request:t,file:e,loadEnd:i},this.createFormData(t.name,a,e,s)}createFormData(e,t,s,i){var o,a;const r=new v(s);return null===(o=this.requestMetadata)||void 0===o||o.formData.append(e,t),null===(a=this.requestMetadata)||void 0===a||a.formData.append("chunkMetadata",JSON.stringify(r)),this.control.customizeFormData||i||(i={}),i?this.onCustomizeChunkMetadataResponse(i):this.customizeFormData(r)}onCustomizeChunkMetadataResponse(e){return new Promise(((t,s)=>{if(null==this.requestMetadata)return void s();const{formData:i,request:o,file:a,loadEnd:r}=this.requestMetadata;if(a.status!==g.Paused&&a.status!==g.Canceled){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const s=e[t];i.append(t,s instanceof Object?JSON.stringify(s):s)}for(const e in o.requestData)Object.prototype.hasOwnProperty.call(o.requestData,e)&&i.append(e,o.requestData[e]);a.request=y.sendRequest(i,{crossDomain:!1,url:o.uploadUrl,method:"POST",headers:o.requestHeaders,onAbort:()=>{a.abort(),s()},onProgress:()=>{},onError:e=>{e.target&&a.error(e.target),s()},onLoadStart:()=>{a.loadStart()},onLoad:e=>{if(e.target)if(200===e.target.status){const n=i.get(o.name);a.chunkIndex++,a.loadedBytes+=n.size,a.progress(),r(a).then(t,s).catch((()=>{s(),a.error(e.target)}))}else a.error(e.target),s()},onLoadEnd:null})}else s()}))}static calculateTotalChunkCount(e,t){let s=Math.trunc(e/t.chunkSize);return e%t.chunkSize>0&&s++,s}}class E extends C{constructor(e){super(e)}upload(e,t,s,i){return e?(this.requestMetadata={formData:new FormData,request:t,file:e,loadEnd:i},this.createFormData(t.name,e,s)):Promise.reject()}createFormData(e,t,s){var i;return null===(i=this.requestMetadata)||void 0===i||i.formData.append(e,t.value),this.onCustomizeChunkMetadataResponse(s||{})}onCustomizeChunkMetadataResponse(e){return new Promise(((e,t)=>{if(null==this.requestMetadata)return void t();const{formData:s,request:i,file:o,loadEnd:a}=this.requestMetadata;for(const e in i.requestData)Object.prototype.hasOwnProperty.call(i.requestData,e)&&s.append(e,i.requestData[e]);let r=!1;o.request=y.sendRequest(s,{url:i.uploadUrl,method:"POST",headers:i.requestHeaders,crossDomain:!1,onProgress:e=>{r=!0,o.loadedBytes=e.loaded>o.fileInfo.size?o.fileInfo.size:e.loaded,o.progress()},onAbort:e=>{o.abort(),t()},onError:e=>{e.target&&o.error(e.target),t()},onLoadStart:e=>{o.loadStart()},onLoad:s=>{s.target&&(200===s.target.status?(r||(o.loadedBytes=o.fileInfo.size,o.progress()),a(o,s).then(e,t).catch((()=>{t(),o.error(s.target)}))):(o.error(s.target),t()))},onLoadEnd:null})}))}}class y{static sendRequest(e,t){const s=new XMLHttpRequest;t.crossDomain=y.isCrossDomain(t.url);const i=y.getRequestHeaders(t);s.open(t.method,t.url,!0),t.onLoadStart&&(s.upload.onloadstart=t.onLoadStart),t.onLoad&&(s.onload=t.onLoad),t.onLoadEnd&&(s.upload.onloadend=t.onLoadEnd),t.onProgress&&(s.upload.onprogress=t.onProgress),t.onError&&(s.upload.onerror=t.onError),t.onAbort&&(s.upload.onabort=t.onAbort);for(const e in i)Object.prototype.hasOwnProperty.call(i,e)&&i[e]&&s.setRequestHeader(e,i[e]);return s.send(e),s}static getRequestHeaders(e){const t=e.headers||{};return t.Accept=t.Accept||y.getAcceptHeader(),e.crossDomain||t["X-Requested-With"]||(t["X-Requested-With"]="XMLHttpRequest"),t}static getAcceptHeader(){return"*/*"}static isCrossDomain(e){let t=!1;const s=document.createElement("a"),i=document.createElement("a");s.href=window.location.href;try{i.href=e,i.href=i.href,t=s.protocol+"//"+s.host!=i.protocol+"//"+i.host}catch(e){t=!0}return t}}class b{constructor(e){this.control=e,this.state=new x,this.indexMap=new Map,this.dispatchTimerId=-1,this.idleTimerId=-1}dispatch(e,t,s=null){const i=this.getFileIndex(t),o=new D(i,e,t.loadedBytes,t.status);this.state.progressInfos.push(o),s&&this.state.errors.push(s),this.tryPerformDispatch()}forceDelayedDispatch(){-1!==this.dispatchTimerId&&clearTimeout(this.dispatchTimerId),this.performDispatch()}tryPerformDispatch(){if(-1===this.dispatchTimerId){let e=50;-1!==this.idleTimerId&&(clearTimeout(this.idleTimerId),this.idleTimerId=-1,e=200),this.dispatchTimerId=setTimeout((()=>this.performDispatch()),e)}}performDispatch(){this.dispatchTimerId=-1,this.control.dispatchEvent(new d(this.state)),this.state=new x,this.indexMap.clear(),this.idleTimerId=setTimeout((()=>{this.idleTimerId=-1}),1e3)}cancelSendingOfLastEvent(){clearTimeout(this.dispatchTimerId),this.dispatchTimerId=-1}getFileIndex(e){let t=this.indexMap.get(e.fileInfo.guid);return void 0!==t||(t=this.state.fileGuids.length,this.state.fileGuids.push(e.fileInfo.guid),this.indexMap.set(e.fileInfo.guid,t)),t}}class x{constructor(){this.fileGuids=[],this.progressInfos=[],this.errors=[]}}class D{constructor(e,t,s,i){this.index=e,this.type=t,this.loaded=s,this.status=i}}var z,M;!function(e){e[e.Started=0]="Started",e[e.Progress=1]="Progress",e[e.Uploaded=2]="Uploaded",e[e.Aborted=3]="Aborted",e[e.Error=4]="Error"}(z||(z={}));class T{}T.MainElement=o.Prefix+"-upload",T.SelectButton=T.MainElement+"-select-btn",function(e){e.accept="accept",e.multiple="multiple"}(M||(M={}));class k extends i{constructor(){super(),this.onInputChangeHandler=this.onFileInputChange.bind(this),this.onSelectButtonClickHandler=this.onSelectButtonClick.bind(this),this.onFilesDropHandler=this.onFilesDrop.bind(this),this.onFilesDragOverHandler=this.onFilesDragOver.bind(this),this.onFilesDragLeaveHandler=this.onFilesDragLeave.bind(this),this.acceptedFileTypes=null,this.allowedFileExtensions=[],this.externalSelectButtonCssSelector="",this.chunkSize=0,this.maxFileSize=0,this.minFileSize=0,this.maxFileCount=1e3,this.multiple=!1,this.uploadMode=m.Instant,this.uploadTechnology=f.Http,this.dragOverClassName="",this.dropZoneCssSelector="",this.customizeFormData=!1,this.files=new Map,this.progressDispatcher=new b(this)}firstUpdated(e){super.firstUpdated(e),this.initEvents(),this.prepareInputElement()}initDotNetReference(e){this.dotnetHelper=e}updateFileStatus(e,t,s){var i,o;null===(o=null===(i=this.files.get(e))||void 0===i?void 0:i.updateStatus)||void 0===o||o.call(i,t,s)}getFileBytes(e){var t;return null===(t=this.files.get(e))||void 0===t?void 0:t.value}getFileInput(){return this.querySelector("input")}getSelectButton(){return this.externalSelectButtonCssSelector?document.querySelector(this.externalSelectButtonCssSelector):this.querySelector(`.${T.SelectButton}`)}getDropZoneContainer(){return this.dropZoneCssSelector?document.querySelector(this.dropZoneCssSelector):null}initEvents(){var e;this.getFileInput().addEventListener("change",this.onInputChangeHandler),null===(e=this.getSelectButton())||void 0===e||e.addEventListener("click",this.onSelectButtonClickHandler);const t=this.getDropZoneContainer();t&&(t.addEventListener("drop",this.onFilesDropHandler),t.addEventListener("dragover",this.onFilesDragOverHandler),t.addEventListener("dragleave",this.onFilesDragLeaveHandler))}prepareInputElement(){const e=this.getFileInput();this.multiple?e.setAttribute(M.multiple,""):e.removeAttribute(M.multiple),this.acceptedFileTypes&&e.setAttribute(M.accept,this.acceptedFileTypes.join(","))}onFileInputChange(e){this.addFiles(this.createFileItems(this.getFileInput().files)),this.getFileInput().value=""}onSelectButtonClick(e){this.getFileInput().click()}onFilesDrop(e){e.preventDefault(),this.addFiles(this.createFileItems(this.getFileFromDataTransfer(e.dataTransfer))),this.onFilesDragLeave(e)}onFilesDragOver(e){this.dragOverClassName&&e.srcElement&&t.DomUtils.addClassName(e.srcElement,this.dragOverClassName),e.preventDefault()}onFilesDragLeave(e){this.dragOverClassName&&t.DomUtils.removeClassName(e.srcElement,this.dragOverClassName)}raiseFilesLimitExceeded(){this.dispatchEvent(new c)}createFileItems(e){if(!e)return[];const t=[],s=this.getAllowedFileTypes();for(let i=0,o=e[i];o;i++,o=e[i]){const a=new S(o,this.getUUID4(),this);a.isValid()&&s&&!this.isFileTypeAllowed(e[i],s)||t.push(a)}return t}isFileTypeAllowed(e,t){return t.some((function(t){if("."===t[0]){if(t=t.replace(".","\\."),e.name.match(new RegExp(t+"$","i")))return!0}else if(t=t.replace("*",""),e.type.match(new RegExp(t,"i")))return!0}))}addFiles(e){0!==e.length&&(this.maxFileCount>0&&this.files.size+e.length>this.maxFileCount?this.raiseFilesLimitExceeded():(e.forEach((e=>this.files.set(e.fileInfo.guid,e))),this.registerFileInfos(e)))}registerFileInfos(e){this.dotnetHelper.invokeMethodAsync("RegisterAddedFiles",this.getFileInfosCollection(e))}getFileFromDataTransfer(e){const t=[];if(e)if(e.items){for(let s=0,i=e.items[s];i;s++,i=e.items[s])if("file"===i.kind){const e=i.getAsFile();e&&t.push(e)}}else for(let s=0,i=e.files[s];i;s++,i=e.files[s])t.push(i);return this.multiple?t:[t[0]]}getFileInfosCollection(e){return e.map(this.createFileViewInfo)}createFileViewInfo(e){return{name:e.fileInfo.name,size:e.fileInfo.size,type:e.fileInfo.type,lastModified:e.fileInfo.lastModified,guid:e.fileInfo.guid,loadedBytes:e.loadedBytes,status:e.status,isFileExtensionValid:e.isFileExtensionValid,isMinSizeValid:e.isMinSizeValid,isMaxSizeValid:e.isMaxSizeValid}}getAllowedFileTypes(){return this.acceptedFileTypes&&this.acceptedFileTypes.length>0?this.acceptedFileTypes.map((e=>e.trim())):null}getUUID4(){const e=new Uint8Array(16);crypto.getRandomValues(e),e[8]&=63,e[8]|=128,e[6]&=15,e[6]|=64;let t=0;return"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX".replace(/XX/g,(()=>e[t++].toString(16).padStart(2,"0")))}reloadFile(e,t){if(e.status===g.Canceled&&t){const s=this.createFileItems([e.value])[0];s.status=g.PendingUpload,s.fileInfo.guid=t,this.files=k.replaceFileInFilesMap(this.files,e.fileInfo.guid,s)}}static replaceFileInFilesMap(e,t,s){const i=new Map;for(const o of e.values()){const e=o.fileInfo.guid===t?s:o;i.set(e.fileInfo.guid,e)}return i}attachEventsToFileItem(e){e.onLoadStart||(e.onLoadStart=()=>{this.fileUploadStarted(e)}),e.onProgress||(e.onProgress=()=>{this.fileProgress(e)}),e.onAbort||(e.onAbort=()=>{this.fileUploadAborted(e)}),e.onError||(e.onError=t=>{this.fileUploadError(e,t.status,t.statusText,t.responseText)}),e.onLoadEnd||(e.onLoadEnd=()=>{this.fileUploaded(e)})}fileUploadStarted(e){this.progressDispatcher.dispatch(z.Started,e)}fileUploaded(e){this.progressDispatcher.dispatch(z.Uploaded,e)}fileUploadAborted(e){this.progressDispatcher.dispatch(z.Aborted,e)}fileProgress(e){e.status!==g.WaitingStart&&e.status!==g.PendingUpload&&e.status!==g.Uploading||this.progressDispatcher.dispatch(z.Progress,e)}fileUploadError(e,t,s,i){this.progressDispatcher.dispatch(z.Error,e,{status:t,statusText:s,responseText:i})}processUploadedFilesOptions(e){this.updateFileStates(e),this.processUploadedFilesOptionsCore(e)}updateFileStates(e){var t;for(const s of e){const e=this.files.get(null!==(t=s.beforeReloadGuid)&&void 0!==t?t:s.fileGuid);e&&(e.status!==s.status&&this.changeStatus(e,s.status,s.fileGuid))}}createActionRequest(e){const t=new F,s=new Map;return e.forEach((e=>{const i=e.file.fileInfo.guid;let o=s.get(i);void 0===o&&(o=t.guids.length,t.guids.push(i),s.set(i,o)),t.actions.push(e.action,o),e.action===g.PendingUpload&&e.newReloadedFile&&t.reloadedFileGuids.push(e.newReloadedFile.fileInfo.guid)})),t}changeStatus(e,t,s){switch(t){case g.PendingUpload:this.reloadFile(e,s);break;case g.Paused:e.status=g.Paused;break;case g.Canceled:this.progressDispatcher.cancelSendingOfLastEvent(),e.abort(!1);break;case g.Removing:this.progressDispatcher.cancelSendingOfLastEvent(),e.abort(!1),this.files.delete(e.fileInfo.guid);break;default:throw new Error("Status not supported.")}}updated(e){(e.has("acceptedFileTypes")||e.has("multiple"))&&this.prepareInputElement()}showFileSelectorDialog(){var e;null===(e=this.getFileInput())||void 0===e||e.click()}}function w(e,t){var s,i;null===(i=null===(s=L(e))||void 0===s?void 0:s.initDotNetReference)||void 0===i||i.call(s,t)}function L(e){return e.isConnected?e:null}e([a({attribute:p.acceptedFileTypes,type:Array})],k.prototype,"acceptedFileTypes",void 0),e([a({attribute:p.allowedFileExtensions,type:Array})],k.prototype,"allowedFileExtensions",void 0),e([a({attribute:p.externalSelectButtonCssSelector})],k.prototype,"externalSelectButtonCssSelector",void 0),e([a({attribute:p.chunkSize,type:Number})],k.prototype,"chunkSize",void 0),e([a({attribute:p.maxFileSize,type:Number})],k.prototype,"maxFileSize",void 0),e([a({attribute:p.minFileSize,type:Number})],k.prototype,"minFileSize",void 0),e([a({attribute:p.maxFileCount,type:Number})],k.prototype,"maxFileCount",void 0),e([a({attribute:p.multiple,type:Boolean})],k.prototype,"multiple",void 0),e([a({attribute:p.uploadMode,type:Number})],k.prototype,"uploadMode",void 0),e([a({attribute:p.uploadTechnology,type:Number})],k.prototype,"uploadTechnology",void 0),e([a({attribute:p.dragOverClassName})],k.prototype,"dragOverClassName",void 0),e([a({attribute:p.dropZoneCssSelector})],k.prototype,"dropZoneCssSelector",void 0),e([a({attribute:p.customizeFormData,type:Boolean})],k.prototype,"customizeFormData",void 0);export{I as C,g as F,h as M,k as U,E as W,f as a,w as i,L as t};
